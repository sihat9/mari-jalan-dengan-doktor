<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Berjalan Bersama Doktor</title>
    <style>
        /* ============ GAYA ASAL TIDAK DIUSIK ============ */
        :root{--primary-color:#2c7be5;--secondary-color:#00d97e;--danger-color:#e63757;--light-color:#f9fafd;--dark-color:#12263f;--gray-color:#95aac9;}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
        body{background-color:#f5f7fa;color:var(--dark-color);line-height:1.6;}
        .container{max-width:800px;margin:0 auto;padding:20px;}
        header{text-align:center;margin-bottom:30px;}
        header .logo{margin-bottom:15px;max-width:150px;height:auto;}
        header h1{color:var(--primary-color);margin-bottom:10px;}
        header p{color:var(--gray-color);}
        form{background:#fff;padding:30px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.05);margin-bottom:30px;}
        .form-group{margin-bottom:20px;}
        label{display:block;margin-bottom:8px;font-weight:500;}
        input[type=text],input[type=tel],input[type=email],textarea{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:5px;font-size:16px;transition:border .3s;}
        input:focus,textarea:focus{outline:none;border-color:var(--primary-color);}
        .phone-input{display:flex;align-items:center;}
        .phone-input .prefix{background:#f0f2f5;padding:12px 10px;border:1px solid #ddd;border-right:none;border-radius:5px 0 0 5px;font-size:16px;}
        .phone-input input{border-radius:0 5px 5px 0;}
        .checkbox-group{display:flex;align-items:center;}
        .checkbox-group input{width:auto;margin-right:10px;}
        .submit-btn{background:var(--primary-color);color:#fff;border:none;padding:12px 25px;font-size:16px;border-radius:5px;cursor:pointer;width:100%;font-weight:500;transition:background .3s;}
        .submit-btn:hover{background:#1c6ed8;}
        .info-box{background:#fff;padding:20px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.05);margin-bottom:30px;}
        .info-box h2{color:var(--primary-color);margin-bottom:10px;font-size:20px;}
        .tentatif-link{display:inline-block;margin-top:10px;color:var(--primary-color);text-decoration:none;font-weight:500;}
        .tentatif-link:hover{text-decoration:underline;}
        #confirmationMessage{background:#e8f4ff;padding:20px;border-radius:5px;margin-bottom:20px;display:none;}
        #confirmationMessage h2{color:var(--primary-color);margin-bottom:10px;}
        .hidden{display:none;}
        .counter{background:#fff;padding:15px;border-radius:5px;box-shadow:0 5px 15px rgba(0,0,0,.05);text-align:center;margin-bottom:20px;}
        .counter p{font-weight:500;margin-bottom:10px;}
        .progress-bar{background:#f0f2f5;height:10px;border-radius:5px;overflow:hidden;}
        .progress{background:var(--secondary-color);height:100%;width:0%;transition:width .5s;}
        footer{text-align:center;margin-top:30px;color:var(--gray-color);font-size:14px;}
        @media(max-width:600px){.container{padding:15px;}form{padding:20px;}}
    </style>
</head>
<body>
<div class="container">
<header>
    <div class="logo">Klinik SihatSokmo</div>
    <h1>Pendaftaran Program "Berjalan Bersama Doktor"</h1>
    <p>10 peserta terawal berpeluang menebus hadiah istimewa!</p>
</header>

<main>
    <!-- ============ BORANG ASAL ============ -->
    <form id="registrationForm">
        <div class="form-group">
            <label for="fullName">Nama Penuh Peserta:</label>
            <input type="text" id="fullName" name="fullName" required>
        </div>
        <div class="form-group">
            <label for="icNumber">No. Kad Pengenalan:</label>
            <input type="text" id="icNumber" name="icNumber" pattern="[0-9]{6}-[0-9]{2}-[0-9]{4}" placeholder="Contoh: 901231-01-1234" required>
        </div>
        <div class="form-group">
            <label for="phoneNumber">No. Telefon:</label>
            <div class="phone-input">
                <span class="prefix">6</span>
                <input type="tel" id="phoneNumber" name="phoneNumber" pattern="[0-9]{9,11}" placeholder="0123456789" required>
            </div>
        </div>
        <div class="form-group">
            <label for="address">Alamat:</label>
            <textarea id="address" name="address" rows="3" required></textarea>
        </div>
        <div class="form-group">
            <label for="email">Email (optional):</label>
            <input type="email" id="email" name="email">
        </div>
        <div class="form-group checkbox-group">
            <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
            <label for="agreeTerms">Saya mengakui bahawa maklumat yang diberikan adalah benar.</label>
        </div>
        <button type="submit" class="submit-btn">Daftar Sekarang</button>
    </form>

    <!-- ============ MAKLUMAT & MODAL ============ -->
    <div class="info-box">
        <h2>Tentatif Program</h2>
        <p>Lihat jadual aktiviti untuk hari program.</p>
        <a href="#" id="tentatifBtn" class="tentatif-link">Klik di sini untuk lihat tentatif</a>
    </div>

    <div id="confirmationMessage" class="hidden">
        <h2>Pendaftaran Berjaya!</h2>
        <p>Terima kasih kerana mendaftar untuk program "Berjalan Bersama Doktor".</p>
        <p id="earlyBirdMessage"></p>
        <p>Sila hadir ke kaunter pendaftaran Klinik SihatSokmo pada hari program dengan membawa kad pengenalan anda.</p>
    </div>

    <div id="counter" class="counter">
        <p>Peserta telah mendaftar: <span id="registeredCount">0</span>/10</p>
        <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
        </div>
    </div>

    <!-- === Modal Tentatif (kod asal dipendekkan untuk penjelasan) === -->
    <div id="tentatifModal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;">
        <div style="background:#fff;padding:30px;border-radius:10px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;">
            <h2 style="color:#2c7be5;margin-bottom:20px;text-align:center;">Tentatif Program</h2>
            <!-- (jadual aktiviti kekal seperti asal) -->
            <button id="closeModalBtn" style="display:block;margin:20px auto 0;padding:8px 20px;background:#2c7be5;color:#fff;border:none;border-radius:5px;cursor:pointer;">Tutup</button>
        </div>
    </div>
</main>

<footer>
    <p>&copy; 2023 Klinik SihatSokmo. Semua hak cipta terpelihara.</p>
</footer>
</div>

<!-- ============ JAVASCRIPT ============ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // DOM refs
    const form              = document.getElementById('registrationForm');
    const confirmationBox   = document.getElementById('confirmationMessage');
    const earlyBirdText     = document.getElementById('earlyBirdMessage');
    const registeredSpan    = document.getElementById('registeredCount');
    const progressBar       = document.getElementById('progressBar');
    const tentatifBtn       = document.getElementById('tentatifBtn');
    const tentatifModal     = document.getElementById('tentatifModal');
    const closeModalBtn     = document.getElementById('closeModalBtn');

    // Config
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwRSq4IDDG59UimVrhA226--hAjbJ0tWocnKvoglY706Bvj6R3jOei3iG8IqtpIUwBC/exec';
    const MAX_EARLY_BIRDS   = 10;
    let   registeredCount   = 0;   // tempatan

    const getTimestamp = () => {
        const n = new Date();
        return `${n.toISOString().split('T')[0]} ${n.toTimeString().split(' ')[0]}`;
    };

    const showError = (msg) => { alert(msg); console.error(msg); };

    const saveLocal = (data) => {
        const pending = JSON.parse(localStorage.getItem('pendingRegistrations') || '[]');
        pending.push(data);
        localStorage.setItem('pendingRegistrations', JSON.stringify(pending));
        console.log('Disimpan tempatan (offline fallback)');
    };

    /* ---------- CORS-SAFE FETCH (no-cors) ---------- */
    async function submitFormData(data) {
        const payload = { ...data, timestamp: getTimestamp() };

        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method : 'POST',
                mode   : 'no-cors',               // <-- tiada CORS error
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body   : JSON.stringify(payload)
            });
            return true;   // dianggap berjaya
        } catch (err) {
            console.error('Gagal hantar:', err);
            saveLocal(data);
            throw err;
        }
    }

    const showConfirmation = (isEarly) => {
        form.style.display          = 'none';
        confirmationBox.style.display = 'block';
        earlyBirdText.textContent   = isEarly ?
            'Tahniah! Anda antara 10 peserta terawal yang layak hadiah!' :
            'Pendaftaran berjaya! Hadiah untuk 10 peserta pertama sudah habis.';
        earlyBirdText.style.color   = isEarly ? '#2ecc71' : '#e74c3c';
    };

    const updateCounter = () => {
        registeredCount++;
        registeredSpan.textContent   = registeredCount;
        progressBar.style.width      = `${Math.min(100, (registeredCount / MAX_EARLY_BIRDS) * 100)}%`;
    };

    // ===== Borang Submit =====
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            fullName  : document.getElementById('fullName').value.trim(),
            icNumber  : document.getElementById('icNumber').value.trim(),
            phoneNumber:'6' + document.getElementById('phoneNumber').value.trim(),
            address   : document.getElementById('address').value.trim(),
            email     : document.getElementById('email').value.trim() || 'N/A'
        };

        // Validasi ringkas
        if (!data.fullName || !data.icNumber || !data.phoneNumber || !data.address) {
            showError('Sila isi semua maklumat yang diperlukan');
            return;
        }
        if (!/^\d{6}-\d{2}-\d{4}$/.test(data.icNumber)) {
            showError('Format No. Kad Pengenalan tidak sah (contoh: 901231-01-1234)');
            return;
        }
        if (!document.getElementById('agreeTerms').checked) {
            showError('Sila setujui terma dan syarat sebelum mendaftar');
            return;
        }

        try {
            await submitFormData(data);
            updateCounter();                                   // kemas kini kiraan
            showConfirmation(registeredCount <= MAX_EARLY_BIRDS); // early-bird lokal
        } catch {
            showError('Pendaftaran gagal. Data disimpan dan akan dicuba semula kemudian.');
        }
    });

    // ===== Hantar semula data tertunda (tanpa respon) =====
    async function resendPending() {
        const pending = JSON.parse(localStorage.getItem('pendingRegistrations') || '[]');
        if (!pending.length) return;
        const stillFailed = [];
        for (const item of pending) {
            try { await submitFormData(item); updateCounter(); }
            catch { stillFailed.push(item); }
        }
        localStorage.setItem('pendingRegistrations', JSON.stringify(stillFailed));
    }

    // ===== Modal Tentatif =====
    tentatifBtn.addEventListener('click', (e) => { e.preventDefault(); tentatifModal.style.display='flex'; });
    closeModalBtn.addEventListener('click',        () => tentatifModal.style.display='none');
    tentatifModal.addEventListener('click', (e) => { if (e.target===tentatifModal) tentatifModal.style.display='none'; });

    // ===== Input helper (IC & telefon) =====
    document.getElementById('icNumber').addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g,'');
        if (v.length>6) v = v.slice(0,6)+'-'+v.slice(6);
        if (v.length>9) v = v.slice(0,9)+'-'+v.slice(9);
        e.target.value = v.slice(0,14);
    });
    document.getElementById('phoneNumber').addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g,'');
    });

    // ===== Init =====
    (function init(){
        registeredSpan.textContent = registeredCount;
        progressBar.style.width    = '0%';
        resendPending();
    })();
});
</script>
</body>
</html>
